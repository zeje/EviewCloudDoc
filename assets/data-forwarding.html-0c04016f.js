import{_ as o}from"./plugin-vue_export-helper-c27b6911.js";import{r as c,o as i,c as r,d as n,e as s,b as e,w as t,f as p}from"./app-c988964a.js";const l={},u=p(`<h1 id="数据转发" tabindex="-1"><a class="header-anchor" href="#数据转发" aria-hidden="true">#</a> 数据转发</h1><blockquote><p>平台提供了多种数据转发的方式，<code>开放OpenApi</code>、<code>在线订阅websocket数据</code>、及<code>MQTT订阅</code></p></blockquote><h2 id="使用websocket订阅实时设备消息" tabindex="-1"><a class="header-anchor" href="#使用websocket订阅实时设备消息" aria-hidden="true">#</a> 使用Websocket订阅实时设备消息</h2><p>可以通过websocket来订阅设备,设备告警等相关消息.</p><h3 id="接口" tabindex="-1"><a class="header-anchor" href="#接口" aria-hidden="true">#</a> 接口</h3><div class="language-tip line-numbers-mode" data-ext="tip"><pre class="language-tip"><code>websocket统一接口为: \`/messaging/{token}\`,
\`{token}\`可通过登录系统或者使用OpenAPI获取. 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>以前端js为例:</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">var</span> ws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">&quot;ws://localhost:8844/messaging/a872d8e6cf6ccd38deb0c8772f6040e3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ws<span class="token punctuation">.</span><span class="token function-variable function">onclose</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
ws<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span><span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">}</span>

<span class="token comment">// 如果认证失败,会立即返回消息: {&quot;message&quot;:&quot;认证失败&quot;,&quot;type&quot;:&quot;authError&quot;},并断开连接.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="订阅消息" tabindex="-1"><a class="header-anchor" href="#订阅消息" aria-hidden="true">#</a> 订阅消息</h3><p>向websocket发送消息,格式为:</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token punctuation">{</span>
    <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sub&quot;</span><span class="token punctuation">,</span> <span class="token comment">//固定为sub</span>
    <span class="token string-property property">&quot;topic&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/device/*/*/**&quot;</span><span class="token punctuation">,</span> <span class="token comment">// topic,见topic列表.</span>
    <span class="token string-property property">&quot;parameter&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>       <span class="token comment">//参数,不同的订阅请求,支持的参数不同</span>
        
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;request-id&quot;</span> <span class="token comment">//请求ID, 请求的标识,服务端在推送消息时,会将此标识一并返回.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container warning"><p class="hint-container-title">注意</p><p>在取消订阅之前,多次传入相同的id是无效的,不会重复订阅.</p></div><p>平台推送消息:</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token punctuation">{</span>
    <span class="token string-property property">&quot;payload&quot;</span><span class="token operator">:</span> <span class="token comment">//消息内容, topic不同,内容不同,</span>
    <span class="token string-property property">&quot;requestId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;request-id&quot;</span><span class="token punctuation">,</span> <span class="token comment">//与订阅请求的id一致</span>
    <span class="token string-property property">&quot;topic&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/device/katch/123456789012345/offline&quot;</span><span class="token punctuation">,</span> <span class="token comment">//topic,实际产生数据的topic</span>
    <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;result&quot;</span> <span class="token comment">//类型 result:订阅结果 complete:结束订阅 error:发生错误 </span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container tip"><p class="hint-container-title">提示</p><p>type为complete时标识本此订阅已结束,通常是订阅有限数据流时(比如发送设备指令),或者取消订阅时会返回此消息.</p></div><h3 id="取消订阅" tabindex="-1"><a class="header-anchor" href="#取消订阅" aria-hidden="true">#</a> 取消订阅</h3><p>向websocket发送消息,格式为:</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token punctuation">{</span>
    <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;unsub&quot;</span><span class="token punctuation">,</span><span class="token comment">//固定为unsub</span>
     <span class="token string-property property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;request-id&quot;</span> <span class="token comment">//与订阅请求ID一致</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="订阅设备消息" tabindex="-1"><a class="header-anchor" href="#订阅设备消息" aria-hidden="true">#</a> 订阅设备消息</h3>`,19),d=n("br",null,null,-1),k=n("code",null,"payload",-1),v=p(`<h3 id="发送设备指令" tabindex="-1"><a class="header-anchor" href="#发送设备指令" aria-hidden="true">#</a> 发送设备指令</h3><p>发送消息到websocket</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token punctuation">{</span>
    <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sub&quot;</span><span class="token punctuation">,</span> <span class="token comment">//固定为sub</span>
    <span class="token string-property property">&quot;topic&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/device-message-sender/katch/123456789012345,123456789012346&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 发送消息给katch型号下的123456789012345和123456789012346设备</span>
    <span class="token string-property property">&quot;parameter&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// 消息类型,支持: READ_PROPERTY (读取属性),WRITE_PROPERTY (修改属性),INVOKE_FUNCTION (调用功能)</span>
        <span class="token string-property property">&quot;messageType&quot;</span><span class="token operator">:</span><span class="token string">&quot;READ_PROPERTY&quot;</span> 
        <span class="token comment">//根据不同的消息,参数也不同. 具体见: 平台统一消息定义</span>
        <span class="token string-property property">&quot;properties&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;temperature&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token comment">//头信息</span>
        <span class="token string-property property">&quot;headers&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
            <span class="token string-property property">&quot;async&quot;</span><span class="token operator">:</span><span class="token boolean">false</span> <span class="token comment">// 是否异步,异步时,平台不等待设备返回指令结果.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;request-id&quot;</span> <span class="token comment">//请求ID, 请求的标识,服务端在推送消息时,会将此标识一并返回.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>平台将推送设备返的结果:</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;payload&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>   <span class="token comment">//请求消息类型不同,结果不同</span>
        <span class="token property">&quot;deviceId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;123456789012345&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;messageType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;READ_PROPERTY_REPLY&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;success&quot;</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//指令是否成功</span>
        <span class="token property">&quot;properties&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;temperature&quot;</span><span class="token operator">:</span> <span class="token number">28.21</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;timestamp&quot;</span><span class="token operator">:</span> <span class="token number">1588148129787</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;requestId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;request-id&quot;</span><span class="token punctuation">,</span> <span class="token comment">//订阅请求的ID</span>
    <span class="token property">&quot;topic&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/device/katch/123456789012345/offline&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;result&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container tip"><p class="hint-container-title">提示</p><p><code>deviceId</code>支持<code>*</code>和逗号<code>,</code>分割,批量发送消息到设备.如: <code>/device-message-sender/{productId}/{deviceId}</code>.<br> 如果要终止发送,直接取消订阅即可.</p></div><h3 id="批量同步设备状态" tabindex="-1"><a class="header-anchor" href="#批量同步设备状态" aria-hidden="true">#</a> 批量同步设备状态</h3><p>发送消息到websocket</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token punctuation">{</span>
    <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sub&quot;</span><span class="token punctuation">,</span> <span class="token comment">//固定为sub</span>
    <span class="token string-property property">&quot;topic&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/device-batch/state-sync&quot;</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;parameter&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string-property property">&quot;query&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string-property property">&quot;where&quot;</span><span class="token operator">:</span><span class="token string">&quot;productId is test-device&quot;</span><span class="token punctuation">}</span><span class="token comment">//查询条件为动态查询条件</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;request-id&quot;</span> <span class="token comment">//请求ID, 请求的标识,服务端在推送消息时,会将此标识一并返回.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>平台推送:</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token punctuation">{</span>
    <span class="token string-property property">&quot;payload&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>   <span class="token comment">//请求消息类型不同,结果不同</span>
        <span class="token string-property property">&quot;deviceId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;123456789012345&quot;</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;state&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string-property property">&quot;value&quot;</span><span class="token operator">:</span><span class="token string">&quot;offline&quot;</span><span class="token punctuation">,</span>
            <span class="token string-property property">&quot;text&quot;</span><span class="token operator">:</span><span class="token string">&quot;离线&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;requestId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;request-id&quot;</span><span class="token punctuation">,</span> <span class="token comment">//订阅请求的ID</span>
    <span class="token string-property property">&quot;topic&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/device-batch/state-sync&quot;</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;result&quot;</span> <span class="token comment">//为comlete是则表示同步完成.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="订阅设备告警数据" tabindex="-1"><a class="header-anchor" href="#订阅设备告警数据" aria-hidden="true">#</a> 订阅设备告警数据</h3><p>发送消息到websocket</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token punctuation">{</span>
    <span class="token string-property property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sub&quot;</span><span class="token punctuation">,</span> <span class="token comment">//固定为sub</span>
    <span class="token string-property property">&quot;topic&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/data-forwarding/device/alarm/{productId}/{deviceId}/{alarmId}&quot;</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;parameter&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;request-id&quot;</span> <span class="token comment">//请求ID, 请求的标识,服务端在推送消息时,会将此标识一并返回.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>平台推送:</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;payload&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>   <span class="token comment">//告警相关数据</span>
        <span class="token property">&quot;deviceId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;设备ID&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;deviceName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;设备名称&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;alarmId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;告警ID&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;alarmName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;告警名称&quot;</span>
        <span class="token comment">//...其他告警数据</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;requestId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;request-id&quot;</span><span class="token punctuation">,</span> <span class="token comment">//订阅请求的ID</span>
    <span class="token property">&quot;topic&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/data-forwarding/device/alarm/{productId}/{deviceId}/{alarmId}&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;result&quot;</span> <span class="token comment">//为comlete是则表示订阅结束.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="使用mqtt订阅平台消息" tabindex="-1"><a class="header-anchor" href="#使用mqtt订阅平台消息" aria-hidden="true">#</a> 使用MQTT订阅平台消息</h2><blockquote><p>tip 提供mqtt方式订阅平台消息的功能.可以通过mqtt来订阅设备,设备告警等相关消息.</p></blockquote><h3 id="认证" tabindex="-1"><a class="header-anchor" href="#认证" aria-hidden="true">#</a> 认证</h3><p>默认使用<code>token</code>(可以使用<code>OpenAPI</code>申请token)作为<code>clientId</code>,<code>username</code>和<code>password</code>可以不填写.</p><h3 id="订阅设备消息-1" tabindex="-1"><a class="header-anchor" href="#订阅设备消息-1" aria-hidden="true">#</a> 订阅设备消息</h3><p>下面列举常用的订阅topic：</p><ul><li><code>/device/*/*/message/event/trackerRealTime</code> 实时数据</li><li><code>/device/*/*/message/event/trackerAlarm</code> 告警</li><li><code>/device/*/*/message/event/iccid</code> iccid变更</li><li><code>/device/*/*/online</code> 设备上线</li><li><code>/device/*/*/offline</code> 设备理想</li><li><code>/_d_s/*/*/message/state/register</code> 设备启用</li><li><code>/_d_s/*/*/message/state/unregister</code> 设备禁用</li><li><code>/_d_s/*/*/message/state/bind</code> 设备与租户绑定</li><li><code>/_d_s/*/*/message/state/unbind</code> 设备与租户解绑</li></ul>`,23);function m(q,b){const a=c("RouterLink");return i(),r("div",null,[u,n("p",null,[s("与消息网关中的设备topic一致,"),e(a,{to:"/zh/best-practices/start.html#%E8%AE%BE%E5%A4%87%E6%B6%88%E6%81%AF%E5%AF%B9%E5%BA%94%E4%BA%8B%E4%BB%B6%E6%80%BB%E7%BA%BFtopic"},{default:t(()=>[s("查看topic列表")]),_:1}),s("."),d,s(" 消息负载("),k,s(")将与"),e(a,{to:"/zh/best-practices/start.html#%E5%B9%B3%E5%8F%B0%E7%BB%9F%E4%B8%80%E8%AE%BE%E5%A4%87%E6%B6%88%E6%81%AF%E5%AE%9A%E4%B9%89"},{default:t(()=>[s("设备消息类型")]),_:1}),s("一致.")]),v])}const h=o(l,[["render",m],["__file","data-forwarding.html.vue"]]);export{h as default};
